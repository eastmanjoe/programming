'################################################
'Property of Draker Laboratories
'
'################################################
'## Configuration ###############################
PipeLineMode

' Const NUM_OF_IPS = 10

'set interval time in seconds for each scan and slow sequence do/while loop
Const CFG_SCAN_INTERVAL_MAIN = 6
Const CFG_SCAN_INTERVAL_CLEAN = 30
Const CFG_SCAN_INTERVAL_DIRTY = 60
' Const CFG_SCAN_INTERVAL_UTIL = 30

'## Declarations ################################
' Public ip_addr(NUM_OF_IPS) As String * 15 = {"10.11.50.10", "10.11.50.21", "10.11.50.53", "10.11.50.24", "10.11.50.56", "10.11.50.61", "10.11.50.23", "10.11.50.180", "166.143.29.138", "10.11.40.24"}
' Public ip_addr_array_length As Long

' Public ping_response_time(NUM_OF_IPS) As Float

Const SP = Chr(32)
Const TB = Chr(9)
Const CR = Chr(13)
Const LF = Chr(10)
Const CRLF = CR & LF
Const QN = Chr(34)
Const DRAKER_ID_FILE = ".draker_id"

Public draker_id(5) As String * 44 = {"Not set", "YYYY-MM-DD", "DAS-1", "", "FALSE"}
Alias draker_id = draker_panel_sn, draker_mfg_date, draker_das_name, _
  draker_model_number, draker_email_sent
Public draker_das_name_save As Boolean

Public cfg_scan_timer_clean As Float
Public cfg_scan_timer_dirty As Float
Public cfg_scan_timer_util As Float
Dim cfg_scan_delay_clean As Long
Dim cfg_scan_delay_dirty As Long
Dim cfg_scan_delay_util As Long

Public cfg_reload As Boolean = TRUE
Public cfg_reload_error As String * 1024
Public cfg_device_total As Long
Public cfg_device_current_clean As String * 32
Public cfg_device_current_dirty As String * 32
Dim cfg_counter_main As Long
Dim cfg_counter_clean As Long
Dim cfg_counter_dirty As Long
Dim cfg_counter As Long

Public ip_info(9) As String * 42
Alias ip_info = datalogger_default_network, datalogger_mac, datalogger_ip, _
  datalogger_netmask, datalogger_gateway, datalogger_ipv6, datalogger_dns1, _
  datalogger_dns2, datalogger_dns3

Dim time_utc(9) As Long
Alias time_utc(1) = time_utc_year
Alias time_utc(2) = time_utc_month
Alias time_utc(3) = time_utc_day
Alias time_utc(4) = time_utc_hr
Alias time_utc(5) = time_utc_min
Alias time_utc(6) = time_utc_sec
Alias time_utc(7) = time_utc_microsec
Alias time_utc(8) = time_utc_day_of_week
Alias time_utc(9) = time_utc_day_of_year

Units cfg_scan_timer_clean = Sec
Units cfg_scan_timer_dirty = Sec
Units cfg_scan_timer_util = Sec

'## Functions ###################################
Function parseIpInfo()
  Dim counter As Long
  Dim buffer_str As String * 42
  Dim line_buffer As String * 255
  Public array_length_ip_info As Long

  array_length_ip_info = ArrayLength(ip_info)

  ' Move(buffer_str, Len(buffer_str), "", 1)
  Erase(buffer_str)
  Erase(ip_info)

  ' For counter = 1 To ArrayLength(ip_info)
  ' For counter = 1 To array_length_ip_info
    ' Move(ip_info(counter), Len(ip_info(counter)), "", 1)
  ' Next

  'parse Status.IPInfo to get current settings
  line_buffer = LowerCase(Status.IPInfo)
  line_buffer = Replace(line_buffer, SP, "")
  line_buffer = Replace(line_buffer, CRLF, ",")

  ' SplitStr(ip_info(), line_buffer, ",", ArrayLength(ip_info), 5)
  SplitStr(ip_info(), line_buffer, ",", array_length_ip_info, 5)

  #If LoggerType = CR1000 Then
    datalogger_ip = Status.IPAddressEth
    datalogger_netmask = Status.IPMaskEth
    datalogger_gateway = Status.IPGateway
  #ElseIf LoggerType = CR800 Then
    datalogger_ip = Status.IPAddressCSIO(1)
    datalogger_netmask = Status.IPMaskCSIO(1)
    datalogger_gateway = Status.IPGatewayCSIO(1)
  #EndIf

  'change mac address format from 00d02c0209b0 to 00:D0:2C:02:09:B0
  datalogger_mac = Right(datalogger_mac, Len(datalogger_mac) - InStr(1, datalogger_mac, ":", 2))
  datalogger_mac = UpperCase(datalogger_mac)

  For counter = 1 To Len(datalogger_mac) Step 2
    buffer_str &= Mid(datalogger_mac, counter, 2)

    If counter < 11 Then buffer_str &= ":"
  Next

  datalogger_mac = buffer_str
  datalogger_ipv6 = Right(datalogger_ipv6, Len(datalogger_ipv6) - InStr(1, datalogger_ipv6, ":", 2))
  datalogger_dns1 = Right(datalogger_dns1, Len(datalogger_dns1) - InStr(1, datalogger_dns1, ":", 2))
  datalogger_dns2 = Right(datalogger_dns2, Len(datalogger_dns2) - InStr(1, datalogger_dns2, ":", 2))
  datalogger_dns3 = Right(datalogger_dns3, Len(datalogger_dns3) - InStr(1, datalogger_dns3, ":", 2))
  'datalogger_dns4 = Right(datalogger_dns4, Len(datalogger_dns4) - InStr(1, datalogger_dns4, ":", 2))
EndFunction 'parseIpInfo

'## Shutdown ####################################
ShutDownBegin

ShutDownEnd



'## Main Program ################################
BeginProg

  parseIpInfo()
  readDrakerID()

  Scan (60,Sec,3,0)

    'Populate the time_utc array with the current timestamp
    RealTime(time_utc())

  NextScan
EndProg
